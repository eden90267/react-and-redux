# Chap08. 單元測試

>“我發現寫單元測試實際上提高了我的編程速度。” ——Martin Fowler

作為驗證程序質量的重要手段之一，測試是一個很大的主題。不過，這一章重點介紹特定於React和Redux應用的單元測試方法。

- 單元測試原則
- React和Redux單元測試環境
- 單元測試React組件的方法
- 單元測試Redux各個部分的方法

因為React和Redux基於函數式編程的思想，所以應用功能更容易拆分成容易測試的模組，對應產出代碼的可測試性也更高。

## 單元測試的原則

從不同角度，可將測試劃分為如下不同的種類：

- 從人工操作還是寫代碼來操作的角度，可以分為**手工測試**和**自動化測試**
- 從是否需要考慮系統的內部設計角度，可以分為**白盒測試**和**黑盒測試**
- 從測試對象的級別，可以分為**單元測試**、**集成測試**和**端到端測試**
- 從測試驗證的系統特性，又可分為**功能測試**、**性能測試**和**壓力測試**  
...

上述的測試種類中，有很多與被測試程序是基於什麼語言、什麼框架沒有任何關係，比如端到端測試。在這裡，我們只探討特定於React和Redux的測試技巧，而體現特殊性的就是單元測試。

單元測試是一種自動化測試，測試代碼和被測的對象非常相關。

單元測試代碼一般都由編寫對應功能代碼的開發者來編寫，開發者提交的單元測試和代碼應該保持一定的覆蓋率，而且必須永遠能夠運行通過。可以說，單元測試是保證代碼質量的第一道防線。

既然說到單元測試，就不得不說測試驅動開發(Test Driven Development，TDD)，有的開發者對測試驅動開發奉為神器，嚴格實踐先寫單元測試測試用例後寫功能代碼，而且單元測試也保證其他開發者不會因為失誤破壞原有的功能；也有開發者對測試驅動開發不以為然，因為寫單元測試的時間是寫功能代碼的好幾倍，當需求發生改變的時候，除了要維護功能代碼，還要維護測試代碼，苦不堪言。

我們這裡只需要正視一點，那就是單元測試應該是讓開發者的工作更輕鬆更高效，而不是成為開發過程中的包袱。

每個開發團隊會根據自身特點決定是否要求測試驅動開發，也可設定恰當的單元測試覆蓋閾值，不過要注意以下幾點：

首先，即使單元測試覆蓋率達到100%，也不表示程序是沒有bug的，實現高質量的軟件有多方面要求，單元測試只是手段之一，不要對單元測試覆蓋率有特過偏執的要求。

另外，程序架構的可測試性非常重要，開發者不喜歡寫單元測試代碼一個很重要的原因就是發現單元測試“太難寫”，比如為了寫一個單元測試要寫太多的模仿對象Mock，涉及複雜的流程難已全部條件分支。

要克服單元測試“太難寫”的問題，就需要架構能把程序拆分成足夠小到方便測試的部分，只要每個小的部分被驗證能夠正確地各司其職，組合起來能夠完成整體功能，那麼開發者編寫的單元測試就可以專注於測試各個小的部分就行，這就是更高的“可測試性”。

只要運用得宜，React和Redux應用的可測試性非常高，因為對應單元測試寫出來大多就是對純函數的測試。

React盡量不存儲狀態，把狀態存儲到Redux的Store上，也就是讓React組件只是一個根據資料負責渲染的純函數就好，這樣的React組件是非常方便測試的。因為純函數的結果根據輸入完全可以預測，而為了測試一個對象在某個狀態下的行為，還要首先讓這個對象處於那個狀態，測試代碼就會變得很長，讓開發者擔心測試代碼本身就可能因為複雜化而出問題。

既然React組件變成了純函數，那Redux就承擔了複雜的狀態管理，那是否Redux部分的可測試性會變低？並沒有，因為Redux的功能由眾多函數組成，這些函數中少依然是純函數，所以測試依然非常簡單。

使用Redux應用，開發者書寫的大部分代碼都屬於action構造函數、reducer或者selector，其中普通的action構造函數和reducer就是純函數，異步action構造函數有副作用所以並不是純函數，在接下來或介紹如何測試異步action構造函數；選擇器雖然包含緩存的副作用，但是對於同樣輸入也有同樣輸出，測試難度不比測試純函數更高。

接下來，我們就介紹單元測試React和Redux程序的方法。